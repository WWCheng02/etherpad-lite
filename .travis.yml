language: node_js

node_js:
  - "lts/*" # Most recent LTS version,

dist: xenial

services:
  - docker

cache: false

## before install phase, install Libreoffice on Ubuntu
before_install:
  - sudo add-apt-repository -y ppa:libreoffice/ppa # install libreoffice through PPA
  - sudo apt-get update # update package
  - sudo apt-get -y install libreoffice # install libreoffice
  - sudo apt-get -y install libreoffice-pdfimport # install pdf import component for LibreOffice
  
before_install:
  - docker build -t node:latest .
  - docker run -d -p 127.0.0.1:80:4567 node/latest /bin/sh -c "cd /root/latest; bundle exec foreman start;"
  - docker ps -a
  - docker run node/latest /bin/sh -c "cd /node/latest; bundle exec rake test"
  
## install dependecy required
install:
  - "bin/installDeps.sh"
  - "cd src && npm install && cd -"
  - "npm install -g etherpad-load-test"



jobs:
  include:
    - name: "Backend test"
      script:
        - "tests/frontend/travis/runnerBackend.sh"
    - name: "Load test"
      script:
        - "tests/frontend/travis/runnerLoadTest.sh"
## Dockerfile tests
#    - name: "Test the Dockerfile"
#      install:
#        - "cd src && npm install && cd -"
#      script:
#        - "docker build -t etherpad:test ."
#        - "docker run -d -p 9001:9001 etherpad:test && sleep 3"
#        - "cd src && npm run test-container"



notifications:
  # notify build results through email
  email:
  - wonweicheng@gmail.com 
